<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="vflex.css" rel="stylesheet">
    <title>vFlex Programmer</title>
    <!--<script src="js/werewolf_comms.js"></script>
    <script src="js/werewolf_comms_leds.js"></script>
    <script src="js/werewolf_util.js"></script>
    <script src="js/werewolf_connect.js"></script>
    <script src="js/werewolf_app_image.js"></script>
    <script src="js/serial.js"></script> -->
    <!-- <script src="js/bootload_app.js"></script> -->
    <!--<script src="app.js"></script>-->
  </head>
  <body class="vflexbody">
    <script type="text/javascript">
      const command_list = Object.freeze ({
        CMD_BOOTLOAD_PROM: 0,
        CMD_JUMP_TO_BOOTLOAD: 1,
        CMD_BOOTLOAD_VERIFY: 2,
        CMD_BOOTLOAD_END: 3,
        CMD_BOOTLOAD_CANCEL_APP_TIMEOUT: 4,
        CMD_BOOTLOAD_RESERVED_0: 5,
        CMD_BOOTLOAD_RESERVED_1: 6,
        CMD_BOOTLOAD_RESERVED_2: 7,
        OK: 8,
        ERROR: 9,
        CMD_VOLTAGE: 10,
        CMD_CURRENT_LIMIT: 11, // optional current limit for pd negotiation
        CMD_WW_SERIAL: 12, // unique device serial number
        CMD_CHIP_UUID: 13, // ch32x035 chip uuid
        CMD_HWID: 14, // werewolf product code
        CMD_FWID: 15, // major.minor.patch
        CMD_MFG_DATE: 16, // DDMMMYYYY
        CMD_FLASH_LED_SEQUENCE_ADVANCED: 17, // write only, read returns confirm sequence received (todo: alternate return when sequence done)
        CMD_FLASH_LED: 18, // simplified flash led sequence. write only, returns confirm sequence received
        CMD_LOAD_CAL_SCRATCHPAD: 19, // load flash memory into ram calibration scratch pad
        CMD_COMMIT_CAL_SCRATCHPAD: 20, // commit scratchpad to flash
        CMD_PDO_LOG: 21,
        CMD_DISABLE_LED_DURING_OPERATION: 22,
        CMD_ENCRYPT_MSG: 23
      });

      // Singleton MIDI handler
      const midiHandler = (() => {
          let midiAccess = null;
          let output = null;
          let input = null;
          let isInitialized = false;

          // Initialize MIDI access and setup listener
          async function initialize() {
              if (isInitialized) return;

              try {
                  midiAccess = await navigator.requestMIDIAccess({ sysex: true });
                  output = Array.from(midiAccess.outputs.values())[0];
                  input = Array.from(midiAccess.inputs.values())[0];

                  if (!output || !input) {
                      console.error("No MIDI output or input found");
                      return;
                  }

                  // Set up the listener once
                  input.onmidimessage = (event) => {
                      if (event.data[0] === 0xF0 && event.data[event.data.length - 1] === 0xF7) {
                          console.log("Received SysEx:", event.data);
                          const payload = event.data.slice(2, -1); // Skip F0, manufacturer ID, and F7
                          console.log("Payload:", payload);
                      }
                  };

                  isInitialized = true;
                  console.log("MIDI initialized");
              } catch (err) {
                  console.error("MIDI Access failed:", err);
              }
          }

          // Reusable send function
          async function sendSysExToDevice(payload) {
              await initialize(); // Ensure MIDI is ready

              if (!output) {
                  console.error("No MIDI output available");
                  return;
              }

              const encoded = [];
              for (let i = 0; i < payload.length; i++) {
                  const byte = payload[i];
                  encoded.push((byte >> 7) & 0x01); // High bit
                  encoded.push(byte & 0x7F);        // Low 7 bits
              }
              const sysex = [0xF0, 0x7D, ...encoded, 0xF7];
              console.log("Sending SysEx:", sysex);
              output.send(sysex);
          }

          return { sendSysExToDevice };
      })();

      async function getVoltage () {
        var array = new Uint8Array(2);
        array[0] = 2; // msg len
        array[1] = command_list.CMD_VOLTAGE;
        await midiHandler.sendSysExToDevice(array);
      }

      async function setVoltage (setting_mv) {
        var array = new Uint8Array(4);
        array[0] = 4; // msg len
        array[1] = command_list.CMD_VOLTAGE | 0x80;

        //let setting_mv = radioArray.value;
        let setting_mv_msb = (setting_mv >> 8)&0xFF;
        let setting_mv_lsb = setting_mv & 0xFF;
        array[2] = setting_mv_msb;
        array[3] = setting_mv_lsb;

        await midiHandler.sendSysExToDevice(array);
        //port.send(array);
      }


      // Usage example
      (async () => {
          console.log('factory');
          getVoltage();
          console.log('fset to 5k');
          setVoltage(5000);
          console.log('read');
          getVoltage();
          console.log('to 9k');
          setVoltage(9000);
          console.log('read');
          getVoltage();
          // Test send #1
          //const sampleData1 = new Uint8Array(32).map((_, i) => i % 256);
          //await midiHandler.sendSysExToDevice(sampleData1);
          //console.log("First SysEx transfer initiated");

          //// Test send #2 (reusing the same setup)
          //const sampleData2 = new Uint8Array(4).map((_, i) => i + 100);
          //await midiHandler.sendSysExToDevice(sampleData2);
          //console.log("Second SysEx transfer initiated");
      })();



    </script>
    <div>
      <h1>vFlex Tool</h1>
    </div>
        
    <button id="edit_voltage">Modify</button>  
  </body>
</html>




