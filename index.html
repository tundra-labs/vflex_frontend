<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="vflex.css" rel="stylesheet">
    <title>vFlex Programmer</title>
    <!--<script src="js/werewolf_comms.js"></script>
    <script src="js/werewolf_comms_leds.js"></script>
    <script src="js/werewolf_util.js"></script>
    <script src="js/werewolf_connect.js"></script>
    <script src="js/werewolf_app_image.js"></script>
    <script src="js/serial.js"></script> -->
    <!-- <script src="js/bootload_app.js"></script> -->
    <!--<script src="app.js"></script>-->
  </head>
  <body class="vflexbody">
    <script type="text/javascript">
      const command_list = Object.freeze ({
        CMD_BOOTLOAD_PROM: 0,
        CMD_JUMP_TO_BOOTLOAD: 1,
        CMD_BOOTLOAD_VERIFY: 2,
        CMD_BOOTLOAD_END: 3,
        CMD_BOOTLOAD_CANCEL_APP_TIMEOUT: 4,
        CMD_BOOTLOAD_RESERVED_0: 5,
        CMD_BOOTLOAD_RESERVED_1: 6,
        CMD_BOOTLOAD_RESERVED_2: 7,
        OK: 8,
        ERROR: 9,
        CMD_VOLTAGE: 10,
        CMD_CURRENT_LIMIT: 11, // optional current limit for pd negotiation
        CMD_WW_SERIAL: 12, // unique device serial number
        CMD_CHIP_UUID: 13, // ch32x035 chip uuid
        CMD_HWID: 14, // werewolf product code
        CMD_FWID: 15, // major.minor.patch
        CMD_MFG_DATE: 16, // DDMMMYYYY
        CMD_FLASH_LED_SEQUENCE_ADVANCED: 17, // write only, read returns confirm sequence received (todo: alternate return when sequence done)
        CMD_FLASH_LED: 18, // simplified flash led sequence. write only, returns confirm sequence received
        CMD_LOAD_CAL_SCRATCHPAD: 19, // load flash memory into ram calibration scratch pad
        CMD_COMMIT_CAL_SCRATCHPAD: 20, // commit scratchpad to flash
        CMD_PDO_LOG: 21,
        CMD_DISABLE_LED_DURING_OPERATION: 22,
        CMD_ENCRYPT_MSG: 23
      });

    let output = null;
    let input = null;
    let receiveBuffer = [];
    let receiveComplete = false;

    // Initialize WebMIDI
    navigator.requestMIDIAccess().then(midiAccess => {
      // Find CH32X035 output (adjust name as seen in MIDI-OX)
      for (let out of midiAccess.outputs.values()) {
        console.log("Output:", out.name);
        if (out.name.includes("vFlex")) { // Adjust based on your device name
          output = out;
          break;
        }
      }
      if (!output) console.error("No output found!");

      // Find CH32X035 input
      for (let inPort of midiAccess.inputs.values()) {
        console.log("Input:", inPort.name);
        if (inPort.name.includes("vFlex")) {
          input = inPort;
          input.onmidimessage = handleMidiMessage;
          break;
        }
      }
      if (!input) console.error("No input found!");
    }, err => console.error("MIDI Access Failed:", err));

      function handleMidiMessage(event) {
      const [status, data1, data2] = event.data;
      console.log("status byte!", status);
      if (status === 0x80) { // Note Off: Clear buffer
        receiveBuffer = [];
        receiveComplete = false;
        console.log("Buffer cleared");
      } else if (status === 0x90) { // Note On: Accumulate 8-bit byte
        if (receiveBuffer.length < 64) {
          const byte = (data1 << 4) | data2; // Recombine high/low nibbles
          receiveBuffer.push(byte);
          console.log(`Added: ${byte.toString(16)} | Buffer size: ${receiveBuffer.length}`);
        }
      } else if (status === 0xA0) { // Start: End of payload
        receiveComplete = true;
        console.log("Payload received:", receiveBuffer.map(b => b.toString(16).padStart(2, '0')));
      }
    }

    // Send a payload to device
    async function sendPayload(payload) {
      if (!output) return console.error("No output device!");
      if (payload.length > 64) payload = payload.slice(0, 64);

      // Clear buffer
      output.send([0x80, 0, 0]); // Note Off
      //console.log("Sent: Clear buffer");
      Delay(10);

      // Send each byte as high/low nibbles
      for (let i = 0; i < payload.length; i++) {
        const byte = payload[i];
        const highNibble = (byte >> 4) & 0x0F; // High 4 bits (0x0-0xF)
        const lowNibble = byte & 0x0F;          // Low 4 bits (0x0-0xF)
        output.send([0x90, highNibble, lowNibble]); // Note On
        //console.log(`Sent: 90 ${highNibble.toString(16)} ${lowNibble.toString(16)}`);
        Delay(10);
      }

      // Signal end
      output.send([0xA0, 0, 0]); // Start
      console.log("Sent: End of payload");
    }

    // Simulate delay (since browser lacks native delay)
    function Delay(ms) {
      const start = Date.now();
      while (Date.now() - start < ms) {}
    }
      async function getVoltage () {
        var array = new Uint8Array(2);
        array[0] = 2; // msg len
        array[1] = command_list.CMD_VOLTAGE;
        await sendPayload(array);
      }

      async function setVoltage (setting_mv) {
        var array = new Uint8Array(4);
        array[0] = 4; // msg len
        array[1] = command_list.CMD_VOLTAGE | 0x80;

        ////let setting_mv = radioArray.value;
        let setting_mv_msb = (setting_mv >> 8)&0xFF;
        let setting_mv_lsb = setting_mv & 0xFF;
        array[2] = setting_mv_msb;
        array[3] = setting_mv_lsb;

        await sendPayload(array);
        //port.send(array);
      }



    // Example: Send a test payload every 5 seconds
    setInterval(() => {
      getVoltage();
      //const payload = Array.from({length: 8}, (_, i) => i + 1); // [1, 2, 3, 4, 5, 6, 7, 8]
      //const payload1 = Array.from({length: 8}, (_, i) => i + 1); // [1, 2, 3, 4, 5, 6, 7, 8]
      //sendPayload(payload);
     //       console.log('fake');
      //setVoltage(5000);
    }, 2000);


      //// Usage example
      //(async () => {
          //console.log('factory');
          //getVoltage();
          ////console.log('fset to 5k');
          ////setVoltage(5000);
          ////console.log('read');
          ////getVoltage();
          ////console.log('to 9k');
          ////setVoltage(9000);
          ////console.log('read');
          ////getVoltage();
          //// Test send #1
          ////const sampleData1 = new Uint8Array(32).map((_, i) => i % 256);
          ////await midiHandler.sendSysExToDevice(sampleData1);
          ////console.log("First SysEx transfer initiated");

          ////// Test send #2 (reusing the same setup)
          ////const sampleData2 = new Uint8Array(4).map((_, i) => i + 100);
          ////await midiHandler.sendSysExToDevice(sampleData2);
          ////console.log("Second SysEx transfer initiated");
      //})();



    </script>
    <div>
      <h1>vFlex Tool</h1>
    </div>
        
    <button id="edit_voltage">Modify</button>  
  </body>
</html>




