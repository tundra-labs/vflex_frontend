<!DOCTYPE html>
<html lang="en">
<head>
    <title>Production server</title>
    <!--<script src="vflex_frontend/js/werewolf_comms.js"></script>
    <script src="vflex_frontend/js/werewolf_comms_leds.js"></script>
    <script src="vflex_frontend/js/werewolf_util.js"></script>
    <script src="vflex_frontend/js/werewolf_connect.js"></script>
    <script type="module" src="vflex_frontend/js/vflex_lib.js"></script>-->
    <style>
        #outputLog {
            width: 300px;
            height: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto; /* adds scrollbar when content overflows */
            white-space: pre-wrap; /* preserves line breaks */
        }
    </style>
</head>
<body>

    <script type="module">
        import {VFLEX_COMMANDS,VFLEX_API} from "../js/vflex_lib.js"
        let vflex = new VFLEX_API();
        let pdos_ws;
        window.pdos_ws_path = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/pdos`;

        //var encrypted_msg = 0;
        //async function waitForEncryptedMsg(){
        //    return new Promise((resolve) => {
        //        const interval = setInterval(() => {
        //            if(encrypted_msg) {
        //                clearInterval(interval);
        //                resolve();
        //            }
        //        }, 25);
        //    });
        //}
        function addToLog(message) {
            const log = document.getElementById('outputLog');
            log.textContent += `${message}\n`;
            log.scrollTop = log.scrollHeight;
        }


        async function vflex_status(){
          if (!vflex.connected){
            console.log('no');
            return;
          } else {
            //console.log('got a midi', midiOutput);
            await vflex.get_string(VFLEX_COMMANDS.CMD_SERIAL_NUMBER);
            addToLog(`serial_num: ${vflex.device_data['serial_num']}`);
            await vflex.get_string(VFLEX_COMMANDS.CMD_HARDWARE_ID);
            addToLog(`hw_id: ${vflex.device_data['hw_id']}`);

            await vflex.get_string(VFLEX_COMMANDS.CMD_MFG_DATE);
            addToLog(`mfg_date: ${vflex.device_data['mfg_date']}`);

            await vflex.get_string(VFLEX_COMMANDS.CMD_FIRMWARE_VERSION);
            addToLog(`fw_id: ${vflex.device_data['fw_id']}`);

            ////get_pdo_log(port)
            await vflex.get_voltage_mv();
            addToLog(`voltage: ${vflex.device_data['voltage_mv']}`);

            //await vflex.pdo_cmd(0); // query number of pdos, result to vflex.device_data.pdo_len
            await vflex.get_full_pdo_log();
            //delete vflex.device_data.pdo_ack
            //for (let i = 1; i <= vflex.device_data.pdo_len ; i++){ 
            //  await vflex.pdo_cmd(i);
            //  delete vflex.device_data.pdo_ack
            //}
            console.log(vflex.device_data.pdo_payload);
            //try {pdos_ws.send(JSON.stringify({N: 2, V_MV : 9000}));}
            //let pdo_json_result = {serial_num : vflex.device_data.serial_num, pdos: vflex.device_data.pdo_payload};
            //try {pdos_ws.send(JSON.stringify(pdo_json_result));}
            //catch (error) {console.log(error);}
            //console.log(JSON.stringify(pdo_json_result));
            //console.log('ok?');

            //pdos_ws_path = window.pdos_ws_path || 'http://localhost:8005'; // check for server path provided from index.html, localhost default
            //pdos_ws  = new WebSocket(pdos_ws_path);
            //try {pdos_ws.send(JSON.stringify({N: 2, V_MV : 9000}));}
            //catch (error) {console.log(error);}



            //get_pdo_log(port);
            //await waitForValue('pdo_log');
            //addToLog(`pdo_log: ${vflex.device_data['pdo_log']}`);
            //console.log(vflex.device_data);
          }
        }
        async function waitForConnected(timeoutMs = 5000) {
          return new Promise((resolve, reject) => {
              const startTime = Date.now();
              const checkInterval = setInterval(() => {
                  if (connected) {
                      clearInterval(checkInterval);
                      resolve(true);
                  } else if (Date.now() - startTime >= timeoutMs) {
                      clearInterval(checkInterval);
                      reject(new Error('Timeout waiting for connection'));
                  }
              }, 100);
          });
        }

      document.addEventListener('DOMContentLoaded', function() {
        //go();
                    //const pdos_ws_path = window.pdos_ws_path || 'http://localhost:8005'; // check for server path provided from index.html, localhost default
                    //console.log(pdos_ws_path);
                    ////const pdos_ws  = new WebSocket(pdos_ws_path);
                    //pdos_ws  = new WebSocket(pdos_ws_path);
                    //pdos_ws.onmessage = function(event){
                    //  encrypted_msg = JSON.parse(event.data);
                    //  console.log("data:", encrypted_msg);
                    //};

            ////try {pdos_ws.send(JSON.stringify({N: 2, V_MV : 9000}));}
            ////catch (error) {console.log(error);}

            vflex.app_autoconnect();
            vflex.on('connect', async () => {
              vflex_status();
              console.log('connected!');
            });
            vflex.on('disconnect', async () => {
              console.log('disconnected!');
              location.reload();
              //vflex.midi.disconnect();
              //setTimeout(() => 
              //{
              //  vflex.app_autoconnect();
              //  // enable button
              //}, 1000);
            });



            //connectButton.addEventListener('click', function() {
            //  vflex.app_autoconnect();
            //});
            //clear_pdo_log_btn.addEventListener('click', function() {
            //  vflex.clear_pdo_log();
            //});
            //send_pdo_log_btn.addEventListener('click', function() {
            //  try {pdos_ws.send(JSON.stringify({N: 2, V_MV : 9000}));}
            //  catch (error) {console.log(error);}
            //  console.log('ok?');
            //});

            //console.log("go");
        });
    </script>

    <!--<div><input id="connectButton" type="button" value="connect"/></div>
    <div><input id="clear_pdo_log_btn" type="button" value="clear pdo log"/></div>
    <div><input id="send_pdo_log_btn" type="button" value="send pdo log"/></div>-->
    _________________________________________<br><br>
    <div id="outputLog"></div>
</body>
</html>
