<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>vFlex Bootloader</title>
    <link rel="stylesheet" href="../vflex.css">
    <script type="module">
        import { VFLEX_API, VFLEX_COMMANDS } from '../js/vflex_lib.js';

        const vflex = new VFLEX_API();
        let encryptedMsg = null;
        let ws = null;

        const status = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-bar-container');
        const executeBtn = document.getElementById('executeBoot');
        const finishBtn = document.getElementById('finishBtn');

        function updateStatus(msg) { status.innerText = msg; }
        function updateProgress(cur, tot) {
            progressBar.style.width = `${(cur/tot)*100}%`;
        }
        function show(el) { el.style.display = 'block'; }
        function hide(el) { el.style.display = 'none'; }

        function delay(ms) { return new Promise(r=>setTimeout(r,ms)); }

        function connectWebSocket(serial) {
            return new Promise((resolve, reject) => {
                const path = window.WS_SECURE_BOOT_APP || 
                    `${location.protocol==='https:'?'wss:':'ws:'}//${location.host}/bootloader`;
                ws = new WebSocket(path);
                ws.binaryType = 'arraybuffer';
                ws.onopen = () => ws.send(serial);
                ws.onmessage = e => {
                    encryptedMsg = JSON.parse(e.data);
                    resolve();
                };
                ws.onerror = ws.onclose = () => reject();
            });
        }

        async function performBootload() {
            hide(executeBtn); show(progressContainer);
            updateStatus('Reading serial…');
            await vflex.get_string(VFLEX_COMMANDS.CMD_SERIAL_NUMBER);
            await connectWebSocket(vflex.device_data.serial_num);

            const app = encryptedMsg.app_bin;
            const expectedCrc = encryptedMsg.crc;
            const total = app.length * 8;
            let sent = 0;

            for (let i = 0; i < app.length; i++) {
                for (let j = 0; j < 8; j++) {
                    const chunk = new Uint8Array(app[i].chunks[j]);
                    await vflex.send_bootloader_chunk_encrypted(chunk, app[i].pg_id, j);
                    updateProgress(++sent, total);
                }
                await vflex.commit_bootloader_page();
            }

            await vflex.verify_bootloader();
            if (vflex.device_data.crc !== expectedCrc) {
                updateStatus(`CRC mismatch: got ${vflex.device_data.crc}`);
                return;
            }

            updateStatus('Bootload successful! Jump to app…');
            await vflex.jump_to_app();
            show(finishBtn);
        }

        async function start() {
            updateStatus('Click “Connect” and select “werewolf vflex”');
            try {
                vflex.bootloader_manual_connect();
                await vflex.serial.await_connected();
                await delay(4000);
                await performBootload();
            } catch (e) {
                updateStatus('Bootload failed – check USB');
                console.error(e);
            } finally {
                hide(progressContainer);
                if (ws) ws.close();
            }
        }

        window.addEventListener('load', () => {
            executeBtn.onclick = start;
            finishBtn.onclick = () => location.href = 'test_vflex_protocol.html';
            hide(progressContainer);
            hide(finishBtn);
        });
    </script>
    <style>
        #progress-bar-container, #finishBtn { display:none; }
        #progress-bar { width:0%; height:30px; background:#2B303B; transition:width .2s; }
    </style>
</head>
<body class="vflexbody">
    <img src="vflex_logo.png" alt="vFlex Logo" class="vflex-logo">
    <h1>vFlex Bootloader</h1>
    <p id="status">Ready – click Connect</p>

    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>

    <button id="executeBoot" class="modify-btn">Connect & Update</button>
    <button id="finishBtn" class="modify-btn">Finish → App</button>
</body>
</html>
